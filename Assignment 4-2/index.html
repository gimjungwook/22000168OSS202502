<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX CRUD - To-Do List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="my.css" />
  </head>
  <body>
    <div class="container mt-5">
      <header class="mb-4">
        <h1 class="text-center fw-bold">To-Do List Manager</h1>
        <p class="text-center text-muted">할 일을 체계적으로 관리하세요</p>
      </header>

      <!-- 추가 버튼 -->
      <div class="mb-3">
        <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#todoModal" onclick="openAddModal()">
          + 새 할 일 추가
        </button>
      </div>

      <!-- 할 일 목록 -->
      <div class="row mb-3">
        <div class="col-12">
          <h2 class="h4 mb-0">할 일 목록</h2>
        </div>
      </div>

      <!-- Desktop View: Table -->
      <div class="table-responsive d-none d-md-block">
        <table class="table table-hover">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>제목</th>
              <th>카테고리</th>
              <th>우선순위</th>
              <th>상태</th>
              <th>마감일</th>
              <th>작업</th>
            </tr>
          </thead>
          <tbody id="todoTableBody">
            <tr>
              <td colspan="7" class="text-center text-muted">
                데이터를 불러오는 중...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mobile View: Cards -->
      <div class="mobile-cards d-md-none" id="todoCards">
        <p class="text-center text-muted">데이터를 불러오는 중...</p>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="todoModal" tabindex="-1" aria-labelledby="todoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="todoModalLabel">새 할 일 추가</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="todoForm">
              <input type="hidden" id="todoId" />
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="title" class="form-label">제목 *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    required
                    minlength="3"
                    maxlength="50"
                  />
                </div>
                <div class="col-md-6">
                  <label for="category" class="form-label">카테고리 *</label>
                  <select class="form-select" id="category" required>
                    <option value="">선택하세요</option>
                    <option value="업무">업무</option>
                    <option value="개인">개인</option>
                    <option value="공부">공부</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="description" class="form-label">설명</label>
                <textarea
                  class="form-control"
                  id="description"
                  rows="2"
                ></textarea>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="priority" class="form-label">우선순위 *</label>
                  <select class="form-select" id="priority" required>
                    <option value="">선택하세요</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="status" class="form-label">상태 *</label>
                  <select class="form-select" id="status" required>
                    <option value="">선택하세요</option>
                    <option value="대기중">대기중</option>
                    <option value="진행중">진행중</option>
                    <option value="완료">완료</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="dueDate" class="form-label">마감일 *</label>
                  <input type="date" class="form-control" id="dueDate" required />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-dark" id="submitBtn" onclick="handleFormSubmit(event)">추가하기</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://6915371d84e8bd126af91a1d.mockapi.io/todo";
      let currentTodos = [];
      let editingId = null;
      let todoModal;

      // 페이지 로드 시 실행
      document.addEventListener("DOMContentLoaded", () => {
        loadTodos();
        todoModal = new bootstrap.Modal(document.getElementById('todoModal'));
      });

      // READ: 모든 할 일 가져오기
      function loadTodos() {
        fetch(API_URL)
          .then((response) => response.json())
          .then((data) => {
            currentTodos = data;
            displayTodos(data);
          })
          .catch((error) => {
            console.error("데이터 불러오기 실패:", error);
            document.getElementById("todoTableBody").innerHTML = `
                        <tr><td colspan="7" class="text-center text-danger">
                            데이터 불러오기 실패. API 연결을 확인하세요.
                        </td></tr>
                    `;
            document.getElementById("todoCards").innerHTML = `
                        <div class="alert alert-danger">데이터 불러오기 실패. API 연결을 확인하세요.</div>
                    `;
          });
      }

      // 할 일 목록 표시
      function displayTodos(todos) {
        // 테이블 뷰 (데스크톱)
        const tableBody = document.getElementById("todoTableBody");
        if (todos.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">등록된 할 일이 없습니다.</td></tr>';
        } else {
          tableBody.innerHTML = todos
            .map(
              (todo) => `
                    <tr style="cursor: pointer;">
                        <th>${todo.id}</th>
                        <td>${todo.title}</td>
                        <td>${todo.category}</td>
                        <td><span class="badge ${getPriorityBadge(
                          todo.priority
                        )}">${todo.priority}</span></td>
                        <td><span class="badge ${getStatusBadge(
                          todo.status
                        )}">${todo.status}</span></td>
                        <td>${todo.dueDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-dark" onclick="editTodo(${
                              todo.id
                            })">수정</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${
                              todo.id
                            })">삭제</button>
                        </td>
                    </tr>
                `
            )
            .join("");
        }

        // 카드 뷰 (모바일)
        const cards = document.getElementById("todoCards");
        if (todos.length === 0) {
          cards.innerHTML =
            '<p class="text-center text-muted">등록된 할 일이 없습니다.</p>';
        } else {
          cards.innerHTML = todos
            .map(
              (todo) => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${todo.title}</h5>
                            <p class="card-text">
                                <span class="badge ${getPriorityBadge(
                                  todo.priority
                                )} me-2">${todo.priority}</span>
                                <span class="badge ${getStatusBadge(
                                  todo.status
                                )} me-2">${todo.status}</span>
                                <small class="text-muted">~${
                                  todo.dueDate
                                }</small>
                            </p>
                            <button class="btn btn-sm btn-outline-dark" onclick="editTodo(${
                              todo.id
                            })">수정</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${
                              todo.id
                            })">삭제</button>
                        </div>
                    </div>
                `
            )
            .join("");
        }
      }

      // Modal 열기 (추가 모드)
      function openAddModal() {
        resetForm();
        todoModal.show();
      }

      // CREATE or UPDATE
      function handleFormSubmit(e) {
        if (e) e.preventDefault();

        const form = document.getElementById("todoForm");
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const todoData = {
          title: document.getElementById("title").value,
          description: document.getElementById("description").value,
          category: document.getElementById("category").value,
          priority: document.getElementById("priority").value,
          status: document.getElementById("status").value,
          dueDate: document.getElementById("dueDate").value,
        };

        if (editingId) {
          updateTodo(editingId, todoData);
        } else {
          createTodo(todoData);
        }
      }

      // CREATE: 새 할 일 추가
      function createTodo(todoData) {
        fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(todoData),
        })
          .then((response) => response.json())
          .then(() => {
            alert("할 일이 추가되었습니다!");
            todoModal.hide();
            resetForm();
            loadTodos();
          })
          .catch((error) => {
            console.error("추가 실패:", error);
            alert("할 일 추가에 실패했습니다.");
          });
      }

      // UPDATE: 할 일 수정
      function updateTodo(id, todoData) {
        fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(todoData),
        })
          .then((response) => response.json())
          .then(() => {
            alert("할 일이 수정되었습니다!");
            todoModal.hide();
            resetForm();
            loadTodos();
          })
          .catch((error) => {
            console.error("수정 실패:", error);
            alert("할 일 수정에 실패했습니다.");
          });
      }

      // DELETE: 할 일 삭제
      function deleteTodo(id) {
        if (!confirm("정말 삭제하시겠습니까?")) return;

        fetch(`${API_URL}/${id}`, {
          method: "DELETE",
        })
          .then(() => {
            alert("할 일이 삭제되었습니다!");
            loadTodos();
          })
          .catch((error) => {
            console.error("삭제 실패:", error);
            alert("할 일 삭제에 실패했습니다.");
          });
      }

      // 수정 모드로 전환
      function editTodo(id) {
        const todo = currentTodos.find((t) => t.id === id);
        if (!todo) return;

        editingId = id;
        document.getElementById("todoModalLabel").textContent = "할 일 수정";
        document.getElementById("title").value = todo.title;
        document.getElementById("description").value = todo.description;
        document.getElementById("category").value = todo.category;
        document.getElementById("priority").value = todo.priority;
        document.getElementById("status").value = todo.status;
        document.getElementById("dueDate").value = todo.dueDate;
        document.getElementById("submitBtn").textContent = "수정하기";

        todoModal.show();
      }

      // 폼 초기화
      function resetForm() {
        editingId = null;
        document.getElementById("todoForm").reset();
        document.getElementById("todoModalLabel").textContent = "새 할 일 추가";
        document.getElementById("submitBtn").textContent = "추가하기";
      }

      // 유틸리티 함수
      function getPriorityBadge(priority) {
        if (priority === "High") return "bg-dark";
        if (priority === "Medium") return "bg-secondary";
        return "bg-white text-dark border";
      }

      function getStatusBadge(status) {
        if (status === "완료") return "bg-dark";
        if (status === "진행중") return "bg-secondary";
        return "bg-white text-dark border";
      }
    </script>
  </body>
</html>
